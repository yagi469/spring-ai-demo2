<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Spring AI Streaming Demo</title>
</head>
<body>
<h1>Spring AI Streaming Chat</h1>
<input type="text" id="prompt-input" placeholder="プロンプトを入力..." size="50">
<button onclick="startStream()">送信</button>
<hr>
<h3>AIからの応答:</h3>
<div id="chat-output" style="border: 1px solid #ccc; padding: 10px; min-height: 100px; white-space: pre-wrap;"></div>

<script>
        let eventSource;
        let characterQueue = []; // 表示すべき文字をためておくキュー
        let isRendering = false; // 現在、文字を表示処理中かどうかのフラグ
        const renderInterval = 30; // 文字を表示する間隔 (ミリ秒)。少し遅くしました。

        function startStream() {
            const prompt = document.getElementById('prompt-input').value;
            const chatOutput = document.getElementById('chat-output');

            if (eventSource) {
                eventSource.close();
            }
            chatOutput.innerHTML = '';
            characterQueue = []; // キューをリセット

            if (!prompt) return;

            const url = `/api/stream/${encodeURIComponent(prompt)}`;
            eventSource = new EventSource(url);

            eventSource.onmessage = function(event) {
                // サーバーから届いたチャンクの文字をキューの末尾に追加
                const chunk = event.data;
                characterQueue.push(...chunk.split(''));

                // もし描画処理が走っていなければ、新しく開始する
                if (!isRendering) {
                    renderCharacters();
                }
            };

            eventSource.onerror = function(error) {
                console.error("EventSource failed:", error);
                isRendering = false;
                eventSource.close();
            };
        }

        function renderCharacters() {
            isRendering = true;
            const chatOutput = document.getElementById('chat-output');

            const intervalId = setInterval(() => {
                // キューに文字があれば、先頭から1つ取り出して表示
                if (characterQueue.length > 0) {
                    chatOutput.innerHTML += characterQueue.shift();
                } else {
                    // キューが空になったら、タイマーを停止して処理を終了
                    clearInterval(intervalId);
                    isRendering = false;
                }
            }, renderInterval);
        }
    </script>
</body>
</html>